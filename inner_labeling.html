<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内层标注系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            color: #333;
            background-color: #f5f5f5;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: #fff;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 20px;
            color: #1890ff;
            margin: 0;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #40a9ff;
        }
        
        .btn-default {
            background-color: #fff;
            color: #333;
            border: 1px solid #d9d9d9;
        }
        
        .btn-default:hover {
            border-color: #40a9ff;
            color: #40a9ff;
        }
        
        .main-content {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .wafer-info {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row {
            display: flex;
            gap: 30px;
            margin-bottom: 8px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-label {
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            font-weight: 600;
        }
        
        .image-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .image-panel {
            flex: 1;
            text-align: center;
        }
        
        .image-panel h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        
        .image-wrapper {
            background-color: #fafafa;
            border: 1px solid #f0f0f0;
            border-radius: 4px;
            padding: 10px;
            min-height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .image-wrapper img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
        }
        
        .defect-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px;
            background-color: #fafafa;
            border-radius: 4px;
        }
        
        .defect-counter {
            font-weight: 600;
            color: #1890ff;
        }
        
        .nav-buttons {
            display: flex;
            gap: 8px;
        }
        
        .defect-info {
            margin-bottom: 20px;
            padding: 16px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        
        .defect-info h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        
        .defect-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #fff;
            border-radius: 4px;
        }
        
        .detail-label {
            color: #666;
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        .labeling-panel {
            margin-bottom: 20px;
            padding: 16px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }
        
        .labeling-panel h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #333;
        }
        
        .labeling-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        .ai-prediction {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }
        
        .prediction-indicator {
            display: inline-block;
            padding: 2px 6px;
            background-color: #e6f7ff;
            color: #1890ff;
            border-radius: 2px;
            font-weight: 500;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .status-success {
            background-color: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .status-warning {
            background-color: #fffbe6;
            color: #faad14;
            border: 1px solid #ffe58f;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部导航栏 -->
        <div class="header">
            <h1>内层标注系统</h1>
            <div class="header-actions">
                <button class="btn btn-default" onclick="exportCurrentKFL()">导出KFL</button>
                <button class="btn btn-default" onclick="saveAndReturn()">保存并返回</button>
            </div>
        </div>
        
        <!-- 主要内容区 -->
        <div class="main-content">
            <div class="loading" id="loading">
                <p>正在加载晶圆数据...</p>
            </div>
            
            <!-- 晶圆基本信息 -->
            <div class="wafer-info" id="wafer-info">
                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">晶圆名称：</span>
                        <span class="info-value" id="wafer-name">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">当前缺陷：</span>
                        <span class="info-value" id="current-defect-index">0/0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">标注进度：</span>
                        <span class="info-value" id="progress-text">0%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">状态：</span>
                        <span class="status-badge status-warning" id="label-status">标注中</span>
                    </div>
                </div>
            </div>
            
            <!-- 图像展示区 -->
            <div class="image-container">
                <div class="image-panel">
                    <h3>明场图像</h3>
                    <div class="image-wrapper">
                        <img id="bright-field-image" src="" alt="明场图像" style="display: none;">
                        <span id="bright-field-placeholder">明场图像加载中...</span>
                    </div>
                </div>
                <div class="image-panel">
                    <h3>暗场图像</h3>
                    <div class="image-wrapper">
                        <img id="dark-field-image" src="" alt="暗场图像" style="display: none;">
                        <span id="dark-field-placeholder">暗场图像加载中...</span>
                    </div>
                </div>
            </div>
            
            <!-- 缺陷导航 -->
            <div class="defect-navigation">
                <div class="defect-counter">缺陷 #<span id="defect-number">1</span></div>
                <div class="nav-buttons">
                    <button class="btn btn-default" onclick="navigateDefect(-1)">上一个</button>
                    <button class="btn btn-default" onclick="navigateDefect(1)">下一个</button>
                </div>
            </div>
            
            <!-- 缺陷详细信息 -->
            <div class="defect-info">
                <h3>缺陷详细信息</h3>
                <div class="defect-details">
                    <div class="detail-item">
                        <span class="detail-label">缺陷ID：</span>
                        <span class="detail-value" id="defect-id">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">X坐标：</span>
                        <span class="detail-value" id="defect-x">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Y坐标：</span>
                        <span class="detail-value" id="defect-y">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">尺寸：</span>
                        <span class="detail-value" id="defect-size">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">强度：</span>
                        <span class="detail-value" id="defect-intensity">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">分类：</span>
                        <span class="detail-value" id="defect-category">--</span>
                    </div>
                </div>
            </div>
            
            <!-- 标注面板 -->
            <div class="labeling-panel">
                <h3>缺陷标注</h3>
                <form class="labeling-form">
                    <div class="form-group">
                        <label for="adc-type">ADC类型</label>
                        <select id="adc-type" required>
                            <option value="">请选择ADC类型</option>
                            <option value="Particle">Particle</option>
                            <option value="Scratch">Scratch</option>
                            <option value="Stain">Stain</option>
                            <option value="Pinhole">Pinhole</option>
                            <option value="Other">Other</option>
                        </select>
                        <div class="ai-prediction">
                            <span class="prediction-indicator">AI预测</span>
                            <span id="ai-prediction">--</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="severity">严重程度</label>
                        <select id="severity" required>
                            <option value="">请选择严重程度</option>
                            <option value="Critical">Critical</option>
                            <option value="Major">Major</option>
                            <option value="Minor">Minor</option>
                            <option value="Negligible">Negligible</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="comment">备注</label>
                        <input type="text" id="comment" placeholder="请输入备注信息（可选）">
                    </div>
                </form>
                
                <div class="form-actions">
                    <button class="btn btn-default" onclick="skipDefect()">跳过</button>
                    <button class="btn btn-primary" onclick="saveLabel()">保存标注</button>
                </div>
            </div>
        </div>
        
        <!-- 底部信息 -->
        <div class="footer">
            <p>© 2025 多晶圆外层管理系统 - 内层标注模块</p>
        </div>
    </div>
    
    <script>
        // 全局变量
        let waferId = null;
        let waferData = null;
        let currentDefectIndex = 0;
        let defectList = [];
        
        // 初始化
        window.onload = function() {
            // 从URL参数中获取wafer_id
            const urlParams = new URLSearchParams(window.location.search);
            waferId = urlParams.get('wafer_id');
            
            if (!waferId) {
                alert('错误：缺少晶圆ID参数');
                window.history.back();
                return;
            }
            
            // 加载晶圆数据
            loadWaferData();
        };
        
        // 显示加载状态
        function showLoading(show) {
            // 确保loading元素存在
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }
        
        // 加载晶圆数据
        function loadWaferData() {
            showLoading(true);
            
            // 调用API获取晶圆数据
            fetch('/api/get_wafer_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'get_wafer_data',
                    params: {
                        wafer_id: waferId
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                
                if (!data.success) {
                    alert('加载晶圆数据失败：' + data.error);
                    window.history.back();
                    return;
                }
                
                // 适配服务器返回的数据结构
                waferData = {
                    wafer_name: waferId,
                    folder_path: waferId, // 临时使用waferId作为folder_path
                    progress: 0,
                    label_status: 1
                };
                // 假设data.data包含缺陷列表，如果没有则创建模拟数据
                defectList = data.data || [{ name: '缺陷1' }];
                
                // 更新页面信息
                updateWaferInfo();
                
                if (defectList.length > 0) {
                    loadDefectData(currentDefectIndex);
                }
            })
            .catch(error => {
                showLoading(false);
                alert('加载失败：' + error.message);
            });
        }
        
        // 更新晶圆信息
        function updateWaferInfo() {
            if (!waferData) return;
            
            document.getElementById('wafer-name').textContent = waferData.wafer_name || '--';
            document.getElementById('current-defect-index').textContent = 
                `1/${defectList.length}`;
            document.getElementById('progress-text').textContent = 
                `${waferData.progress || 0}%`;
            
            // 更新状态标签
            const statusBadge = document.getElementById('label-status');
            if (waferData.label_status === 2) {
                statusBadge.className = 'status-badge status-success';
                statusBadge.textContent = '标注完成';
            } else {
                statusBadge.className = 'status-badge status-warning';
                statusBadge.textContent = '标注中';
            }
        }
        
        // 加载缺陷数据
        function loadDefectData(index) {
            if (index < 0 || index >= defectList.length) {
                console.error('缺陷索引超出范围');
                return;
            }
            
            const defect = defectList[index];
            currentDefectIndex = index;
            
            // 更新缺陷计数
            document.getElementById('current-defect-index').textContent = 
                `${index + 1}/${defectList.length}`;
            document.getElementById('defect-number').textContent = index + 1;
            
            // 根据标注次数显示不同的颜色标识
            const labelCountIndicator = document.getElementById('label-count-indicator');
            if (!labelCountIndicator) {
                // 如果不存在，创建一个新的元素
                const indicator = document.createElement('span');
                indicator.id = 'label-count-indicator';
                indicator.className = 'label-count-indicator';
                indicator.style.marginLeft = '8px';
                indicator.style.padding = '2px 6px';
                indicator.style.borderRadius = '2px';
                indicator.style.fontSize = '12px';
                document.getElementById('defect-number').parentElement.appendChild(indicator);
            }
            
            // 设置标注次数和颜色
            const count = defect.label_count || 0;
            const indicator = document.getElementById('label-count-indicator');
            indicator.textContent = `标注${count}次`;
            
            // 根据标注次数设置不同颜色
            if (count === 0) {
                indicator.style.display = 'none'; // 未标注不显示
            } else if (count === 1) {
                indicator.style.display = 'inline-block';
                indicator.style.backgroundColor = '#f6ffed';
                indicator.style.color = '#52c41a';
                indicator.style.border = '1px solid #b7eb8f';
            } else if (count === 2) {
                indicator.style.display = 'inline-block';
                indicator.style.backgroundColor = '#fffbe6';
                indicator.style.color = '#faad14';
                indicator.style.border = '1px solid #ffe58f';
            } else if (count >= 3) {
                indicator.style.display = 'inline-block';
                indicator.style.backgroundColor = '#fff1f0';
                indicator.style.color = '#ff4d4f';
                indicator.style.border = '1px solid #ffccc7';
            }
            
            // 更新缺陷信息
            document.getElementById('defect-id').textContent = defect.id || '--';
            document.getElementById('defect-x').textContent = defect.x || '--';
            document.getElementById('defect-y').textContent = defect.y || '--';
            document.getElementById('defect-size').textContent = defect.size || '--';
            document.getElementById('defect-intensity').textContent = defect.intensity || '--';
            document.getElementById('defect-category').textContent = defect.category || '--';
            
            // 更新标注表单
            document.getElementById('adc-type').value = defect.adc_type || '';
            document.getElementById('severity').value = defect.severity || '';
            document.getElementById('comment').value = defect.comment || '';
            document.getElementById('ai-prediction').textContent = defect.ai_adc_type || '--';
            
            // 加载图像
            loadImages();
        }
        
        // 加载图像
        function loadImages() {
            // 显示加载状态
            document.getElementById('bright-field-image').style.display = 'none';
            document.getElementById('bright-field-placeholder').style.display = 'inline';
            document.getElementById('dark-field-image').style.display = 'none';
            document.getElementById('dark-field-placeholder').style.display = 'inline';
            
            // 使用正确的API路径加载图像
            setTimeout(() => {
                // 直接使用固定的图像路径
                document.getElementById('bright-field-placeholder').style.display = 'none';
                document.getElementById('bright-field-image').style.display = 'block';
                document.getElementById('bright-field-image').src = '/api/get_image?wafer_id=' + waferId + '&image_path=bright_field.png';
                
                document.getElementById('dark-field-placeholder').style.display = 'none';
                document.getElementById('dark-field-image').style.display = 'block';
                document.getElementById('dark-field-image').src = '/api/get_image?wafer_id=' + waferId + '&image_path=dark_field.png';
            }, 500);
        }
        
        // 导航到上一个/下一个缺陷
        function navigateDefect(direction) {
            const newIndex = currentDefectIndex + direction;
            
            if (newIndex >= 0 && newIndex < defectList.length) {
                // 保存当前缺陷的状态
                saveCurrentDefectState();
                // 加载新缺陷
                loadDefectData(newIndex);
            }
        }
        
        // 保存当前缺陷状态（用于临时保存）
        function saveCurrentDefectState() {
            if (currentDefectIndex < 0 || currentDefectIndex >= defectList.length) return;
            
            const defect = defectList[currentDefectIndex];
            defect.adc_type = document.getElementById('adc-type').value;
            defect.severity = document.getElementById('severity').value;
            defect.comment = document.getElementById('comment').value;
        }
        
        // 保存标注
        function saveLabel() {
            const adcType = document.getElementById('adc-type').value;
            const severity = document.getElementById('severity').value;
            const comment = document.getElementById('comment').value;
            
            if (!adcType) {
                alert('请填写缺陷类型');
                return;
            }
            
            showLoading(true);
            
            // 调用API保存标注
            fetch('/api/save_label', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'save_label',
                    params: {
                        wafer_id: waferId,
                        defect_index: currentDefectIndex,
                        adc_type: adcType,
                        severity: severity,
                        comment: comment
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                
                if (data.success) {
                    // 自动导航到下一个缺陷
                    if (currentDefectIndex < defectList.length - 1) {
                        navigateDefect(1);
                    } else {
                        alert('已完成所有缺陷标注！');
                    }
                } else {
                    alert('保存失败：' + data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                alert('保存失败：' + error.message);
            });
        }
        
        // 跳过缺陷
        function skipDefect() {
            navigateDefect(1);
        }
        
        // 导出当前KFL
        function exportCurrentKFL() {
            showLoading(true);
            
            fetch('/api/export_kfl', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'export_kfl',
                    params: {
                        wafer_id: waferId,
                        export_all: false
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                
                if (data.success) {
                    alert('导出成功！');
                } else {
                    alert('导出失败：' + data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                alert('导出失败：' + error.message);
            });
        }
        
        // 保存并返回
        function saveAndReturn() {
            if (confirm('确定要保存当前进度并返回外层管理界面吗？')) {
                showLoading(true);
                
                // 获取当前标注信息
                const adcType = document.getElementById('adc-type').value;
                const severity = document.getElementById('severity').value;
                const comment = document.getElementById('comment').value;
                
                // 如果当前缺陷有标注信息，先保存到数据库
                if (adcType && severity) {
                    // 调用保存API
                    fetch('/api/save_label', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'save_label',
                            params: {
                                wafer_id: waferId,
                                defect_index: currentDefectIndex,
                                adc_type: adcType,
                                severity: severity,
                                comment: comment
                            }
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        showLoading(false);
                        if (data.success) {
                            alert('保存成功！');
                            window.location.href = '/';
                        } else {
                            alert('保存失败：' + (data.error || '未知错误'));
                            showLoading(false);
                        }
                    })
                    .catch(error => {
                        alert('保存过程中发生错误：' + error.message);
                        showLoading(false);
                    });
                } else {
                    // 如果没有标注信息，直接返回
                    showLoading(false);
                    window.location.href = '/';
                }
            }
        }
        

        
        // 监听页面关闭事件，提醒用户保存
        window.addEventListener('beforeunload', function(e) {
            const confirmationMessage = '您有未保存的标注，确定要离开吗？';
            e.returnValue = confirmationMessage;
            return confirmationMessage;
        });
    </script>
</body>
</html>